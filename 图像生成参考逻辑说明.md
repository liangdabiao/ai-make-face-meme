# å›¾åƒç”Ÿæˆå‚è€ƒé€»è¾‘è¯´æ˜

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**ä½ é—®ï¼š** ç”Ÿæˆçš„ç¬¬3ä¸ªå›¾ç‰‡æ˜¯åŸºäºç¬¬ä¸€ä¸ªå›¾è¿˜æ˜¯åŸºäºç¬¬äºŒä¸ªä½œä¸ºå‚è€ƒå›¾ï¼Ÿ

**ç­”æ¡ˆï¼š** **æ‰€æœ‰ç”Ÿæˆçš„å›¾ç‰‡éƒ½æ˜¯åŸºäºç”¨æˆ·ä¸Šä¼ çš„åŸå§‹å›¾ç‰‡ä½œä¸ºå‚è€ƒ**ï¼Œè€Œä¸æ˜¯åŸºäºå‰é¢ç”Ÿæˆçš„å›¾ç‰‡ã€‚

## ğŸ“‹ ä»£ç åˆ†æ

### 1. å›¾åƒç”Ÿæˆæµç¨‹ (`src/app/api/stop-motion/route.ts`)

```typescript
export async function POST(request: NextRequest) {
  const formData = await request.formData();
  const image = formData.get("image") as File | null;

  // 1. åˆ›å»ºåŸå§‹å›¾ç‰‡çš„ç¼“å†²åŒº - æ‰€æœ‰åç»­ç”Ÿæˆçš„å¸§éƒ½åŸºäºè¿™ä¸ªåŸå§‹å›¾ç‰‡
  const buffer = Buffer.from(await image.arrayBuffer());

  // 2. ç”Ÿæˆå§¿åŠ¿åºåˆ—
  const posesData = await generatePosesFromImageBuffer(buffer, image.type, 12);
  const posesJson = JSON.parse(posesData ?? "{}");

  // 3. å¾ªç¯ç”Ÿæˆæ¯ä¸€å¸§
  if (posesJson.poses && Array.isArray(posesJson.poses)) {
    for (let i = 0; i < posesJson.poses.length; i++) {
      const pose = posesJson.poses[i];

      // å…³é”®ï¼šæ¯ä¸€å¸§éƒ½ä½¿ç”¨åŒä¸€ä¸ªåŸå§‹å›¾ç‰‡ç¼“å†²åŒº
      const nanobananaResult = await nanobanana(prompt, buffer, {
        responseFormat: 'b64_json',
        aspectRatio: '4:3'
      });
    }
  }
}
```

### 2. å‚è€ƒå›¾åƒä¼ é€’æœºåˆ¶ (`src/lib/ai.ts`)

```typescript
export async function nanobanana(
  prompt: string,
  imageBuffer?: Buffer,  // è¿™å§‹ç»ˆæ˜¯åŸå§‹å›¾ç‰‡çš„ç¼“å†²åŒº
  options: NanobananaOptions = {}
) {
  const requestBody: NanobananaRequest = {
    model: options.model || 'nano-banana',
    prompt: prompt,
  };

  // æ·»åŠ å‚è€ƒå›¾åƒ - å§‹ç»ˆæ˜¯ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹å›¾ç‰‡
  if (imageBuffer) {
    // å¦‚æœæœ‰å‚è€ƒå›¾åƒï¼Œä½¿ç”¨base64æ ¼å¼
    requestBody.image = [imageBuffer.toString('base64')];
  }

  // å‘é€è¯·æ±‚åˆ°NanoBanana API
  const response = await fetch(`${BASE_URL}/v1/images/generations`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${API_KEY}`,
    },
    body: JSON.stringify(requestBody), // åŒ…å«åŸå§‹å›¾ç‰‡ + åŠ¨ä½œæè¿°
  });
}
```

## ğŸ”„ è¯¦ç»†æµç¨‹è¯´æ˜

### å›¾åƒç”Ÿæˆæ­¥éª¤ï¼š

1. **ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡** â†’ åŸå§‹å›¾ç‰‡ä¿å­˜åœ¨å†…å­˜ä¸­ä½œä¸º `buffer`

2. **ç”ŸæˆåŠ¨ä½œæè¿°** â†’ AIåˆ†æåŸå§‹å›¾ç‰‡ï¼Œç”Ÿæˆ12ä¸ªè¿ç»­åŠ¨ä½œæè¿°

3. **é€å¸§ç”Ÿæˆ**ï¼š
   - ç¬¬1å¸§ï¼š`nanobanana(åŠ¨ä½œ1çš„æè¿°, åŸå§‹å›¾ç‰‡)`
   - ç¬¬2å¸§ï¼š`nanobanana(åŠ¨ä½œ2çš„æè¿°, åŸå§‹å›¾ç‰‡)`
   - ç¬¬3å¸§ï¼š`nanobanana(åŠ¨ä½œ3çš„æè¿°, åŸå§‹å›¾ç‰‡)`
   - ...
   - ç¬¬12å¸§ï¼š`nanobanana(åŠ¨ä½œ12çš„æè¿°, åŸå§‹å›¾ç‰‡)`

### æ¯ä¸€å¸§çš„æç¤ºè¯ç¤ºä¾‹ï¼š

```typescript
// ç¬¬1å¸§æç¤ºè¯
const prompt1 = `åŸºäºå‚è€ƒå›¾åƒï¼Œç”Ÿæˆç¬¦åˆä»¥ä¸‹å§¿åŠ¿æè¿°çš„é™æ­¢ç”»é¢å¸§ï¼š
å§¿åŠ¿æè¿°ï¼šCharacter in neutral starting position, standing upright with natural posture
åŠ¨ä½œæ­¥éª¤ï¼š1
è¦æ±‚ï¼š
- ä¸¥æ ¼éµå¾ªå‚è€ƒå›¾åƒä¸­è§’è‰²/ç‰©ä½“çš„åŸºæœ¬å¤–è§‚ã€æ¯”ä¾‹å’Œç‰¹å¾
- ç²¾ç¡®åº”ç”¨å§¿åŠ¿æè¿°ä¸­çš„åŠ¨ä½œè¦æ±‚
// ... æ›´å¤šè¦æ±‚`;

// ç¬¬2å¸§æç¤ºè¯
const prompt2 = `åŸºäºå‚è€ƒå›¾åƒï¼Œç”Ÿæˆç¬¦åˆä»¥ä¸‹å§¿åŠ¿æè¿°çš„é™æ­¢ç”»é¢å¸§ï¼š
å§¿åŠ¿æè¿°ï¼šCharacter beginning to move, slight shift in weight or position
åŠ¨ä½œæ­¥éª¤ï¼š2
è¦æ±‚ï¼š
- ä¸¥æ ¼éµå¾ªå‚è€ƒå›¾åƒä¸­è§’è‰²/ç‰©ä½“çš„åŸºæœ¬å¤–è§‚ã€æ¯”ä¾‹å’Œç‰¹å¾
- ç²¾ç¡®åº”ç”¨å§¿åŠ¿æè¿°ä¸­çš„åŠ¨ä½œè¦æ±‚`;
// ... æ›´å¤šè¦æ±‚`;
```

## âš ï¸ å½“å‰å®ç°çš„ä¼˜åŠ¿å’Œé™åˆ¶

### âœ… ä¼˜åŠ¿ï¼š
1. **ä¸€è‡´æ€§ä¿è¯**ï¼šæ‰€æœ‰å¸§éƒ½åŸºäºåŒä¸€å¼ åŸå›¾ï¼Œç¡®ä¿è§’è‰²/ç‰©ä½“å¤–è§‚é«˜åº¦ä¸€è‡´
2. **ç¨³å®šæ€§**ï¼šä¸ä¼šå› ä¸ºå‰é¢ç”Ÿæˆçš„å›¾åƒæœ‰å°é”™è¯¯è€Œç´¯ç§¯è¯¯å·®
3. **å¯æ§æ€§**ï¼šå¯ä»¥ç²¾ç¡®å®šä¹‰æ¯ä¸ªåŠ¨ä½œçš„ç¨‹åº¦å’Œå˜åŒ–

### âŒ é™åˆ¶ï¼š
1. **ç¼ºä¹è¿ç»­æ€§**ï¼šç¬¬2å¸§ä¸çŸ¥é“ç¬¬1å¸§çš„å…·ä½“çŠ¶æ€ï¼Œå¯èƒ½å¯¼è‡´åŠ¨ä½œè·³è·ƒ
2. **ç‰©ç†çº¦æŸå¼±**ï¼šæ— æ³•ç²¾ç¡®æ¨¡æ‹ŸçœŸå®çš„ç‰©ç†è¿åŠ¨è½¨è¿¹
3. **ç»†èŠ‚å˜åŒ–æœ‰é™**ï¼šéš¾ä»¥å¤„ç†éœ€è¦é€æ¸å˜åŒ–çš„ç»†èŠ‚ï¼ˆå¦‚è¡£æœè¤¶çš±ã€é˜´å½±å˜åŒ–ï¼‰

## ğŸ”§ æ”¹è¿›å»ºè®®

å¦‚æœéœ€è¦å®ç°æ›´å¥½çš„åŠ¨ç”»è¿ç»­æ€§ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹æ”¹è¿›æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆ1ï¼šæ¸è¿›å¼å‚è€ƒ
```typescript
// ä¼ªä»£ç ç¤ºä¾‹
let referenceBuffer = originalBuffer;
for (let i = 0; i < poses.length; i++) {
  const newFrame = await nanobanana(
    poses[i].description,
    referenceBuffer  // ä½¿ç”¨å‰ä¸€å¸§ä½œä¸ºå‚è€ƒ
  );
  referenceBuffer = newFrame.buffer; // æ›´æ–°å‚è€ƒå›¾ç‰‡
}
```

### æ–¹æ¡ˆ2ï¼šæ··åˆå‚è€ƒç­–ç•¥
```typescript
// ä¼ªä»£ç ç¤ºä¾‹
for (let i = 0; i < poses.length; i++) {
  const references = [];
  if (i > 0) references.push(previousFrame.buffer);
  references.push(originalBuffer); // å§‹ç»ˆåŒ…å«åŸå›¾ä½œä¸ºå¤–è§‚é”šå®š

  const newFrame = await nanobanana(
    poses[i].description,
    references
  );
}
```

### æ–¹æ¡ˆ3ï¼šæ™ºèƒ½æç¤ºå¢å¼º
```typescript
// åœ¨æç¤ºè¯ä¸­åŠ å…¥è¿ç»­æ€§ä¿¡æ¯
const prompt = `åŸºäºå‚è€ƒå›¾åƒï¼Œç”Ÿæˆç¬¦åˆä»¥ä¸‹å§¿åŠ¿æè¿°çš„é™æ­¢ç”»é¢å¸§ï¼š
å§¿åŠ¿æè¿°ï¼š${pose.description}
å‰åºåŠ¨ä½œï¼š${i > 0 ? previousPose.description : 'èµ·å§‹çŠ¶æ€'}
åç»­åŠ¨ä½œï¼š${i < poses.length - 1 ? nextPose.description : 'ç»“æŸçŠ¶æ€'}

è¦æ±‚ï¼š
- ç¡®ä¿ä¸å‰åºåŠ¨ä½œçš„å¹³æ»‘è¿‡æ¸¡
- è€ƒè™‘åç»­åŠ¨ä½œçš„æ–¹å‘æ€§
- ä¿æŒè¿åŠ¨è½¨è¿¹çš„è¿ç»­æ€§`;
```

## ğŸ“Š å½“å‰æ¶æ„å›¾

```
ç”¨æˆ·ä¸Šä¼ åŸå›¾
    â†“
åˆ›å»ºå›¾åƒç¼“å†²åŒº (åŸå§‹å›¾ç‰‡)
    â†“
AIåˆ†æç”Ÿæˆ12ä¸ªåŠ¨ä½œæè¿°
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é€å¸§ç”Ÿæˆå¾ªç¯ (12æ¬¡)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¸§1: nanobanana(åŠ¨ä½œ1, åŸå§‹å›¾ç‰‡)        â”‚
â”‚ å¸§2: nanobanana(åŠ¨ä½œ2, åŸå§‹å›¾ç‰‡)        â”‚
â”‚ å¸§3: nanobanana(åŠ¨ä½œ3, åŸå§‹å›¾ç‰‡)        â”‚
â”‚ ...                                    â”‚
â”‚ å¸§12: nanobanana(åŠ¨ä½œ12, åŸå§‹å›¾ç‰‡)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æµå¼ä¼ è¾“åˆ°å‰ç«¯
    â†“
ç”¨æˆ·çœ‹åˆ°åŠ¨ç”»åºåˆ—
```

## ğŸ¯ æ€»ç»“

**å½“å‰å®ç°çš„å›¾åƒç”Ÿæˆé€»è¾‘æ˜¯ï¼š**
- **æ¯ä¸€å¸§éƒ½åŸºäºç”¨æˆ·ä¸Šä¼ çš„åŸå§‹å›¾ç‰‡**
- **é€šè¿‡ä¸åŒçš„åŠ¨ä½œæè¿°æ¥å®ç°åŠ¨ç”»æ•ˆæœ**
- **ä¼˜ç‚¹æ˜¯ç¡®ä¿å¤–è§‚ä¸€è‡´æ€§ï¼Œç¼ºç‚¹æ˜¯å¯èƒ½ç¼ºä¹åŠ¨ä½œè¿ç»­æ€§**

è¿™ç§è®¾è®¡ç¡®ä¿äº†è§’è‰²æˆ–ç‰©ä½“çš„å¤–è§‚åœ¨æ‰€æœ‰å¸§ä¸­ä¿æŒä¸€è‡´ï¼Œä½†å¯èƒ½éœ€è¦é€šè¿‡æ›´å¥½çš„æç¤ºè¯è®¾è®¡æ¥æ”¹å–„åŠ¨ä½œçš„æµç•…æ€§ã€‚